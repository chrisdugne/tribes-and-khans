<?xml version="1.0" encoding="utf-8"?>
<s:Group xmlns:fx="http://ns.adobe.com/mxml/2009" 
		 xmlns:s="library://ns.adobe.com/flex/spark" 
		 xmlns:mx="library://ns.adobe.com/flex/mx" 
		 xmlns:renderers="com.uralys.tribes.renderers.*"
		 xmlns:components="com.uralys.tribes.components.*" 
		 xmlns:windows="com.uralys.tribes.windows.*" 
		 width="100%" height="100%"
		 creationComplete="initBoard()" 
		 >
	
	<fx:Script>
		<![CDATA[
			//---------------------------------------------------------------------------------------//
			
			import com.uralys.tribes.commons.Numbers;
			import com.uralys.tribes.commons.Session;
			import com.uralys.tribes.commons.Translations;
			import com.uralys.tribes.core.BoardClickAnalyser;
			import com.uralys.tribes.core.BoardDrawer;
			import com.uralys.tribes.core.Pager;
			import com.uralys.tribes.core.UnitMover;
			import com.uralys.tribes.entities.Cell;
			import com.uralys.tribes.entities.City;
			import com.uralys.tribes.entities.Game;
			import com.uralys.tribes.entities.Move;
			import com.uralys.tribes.entities.Player;
			import com.uralys.tribes.entities.Unit;
			import com.uralys.tribes.main.ImageContainer;
			import com.uralys.tribes.managers.GameManager;
			import com.uralys.tribes.renderers.Pawn;
			import com.uralys.tribes.skins.ClassicProgressBarSkin;
			import com.uralys.tribes.skins.CustomProgressTrackSkin;
			import com.uralys.utils.Utils;
			
			import mx.containers.TitleWindow;
			import mx.core.FlexGlobals;
			import mx.effects.easing.Quadratic;
			import mx.events.ItemClickEvent;
			
			//---------------------------------------------------------------------------------------//
			
			[Bindable] public var selectedCity:City;

			//----------------------------------------------------------//

			[Bindable] public var boardPositionX:int = 150;
			[Bindable] public var boardPositionY:int = 50;
			
			//----------------------------------------------------------//

			// set params est appelee avant creationComplete (initBoard())
			public function set params(args:Array):void
			{
				FlexGlobals.topLevelApplication.header.loginWindow.closeWindow();
				selectedCity = Session.player.cities.getItemAt(0) as City;
				trace("Board.set params : " + selectedCity);
				
				if(Session.player.name == "New Player"){
					showChangeName.play();
				}
			}
			
			//==============================================================================================================//
			// 	Game management
			
			private function initBoard():void
			{
				trace("Board.initBoard : " + selectedCity);
				Session.timer.start();
				
				if(selectedCity == null){
					FlexGlobals.topLevelApplication.message('GAME OVER ON THIS SERVER', 700);
					Session.GAME_OVER = true;
					
					selectedCity = new City();
					selectedCity.x = 100;
					selectedCity.y = 100;
					
					GameManager.getInstance().initMap(100, 100);
				}
				
				//------------------------------------------------------------//

				Session.board = this;
				placeBoard(selectedCity.x, selectedCity.y, false);
				
				GameManager.getInstance().refreshPlayer(Session.player);
			}
	
			//----------------------------------------------------------------------------------------//

			/**
			 * le BoardClickListener regarde si il y a une ville dans la case clickee et arrive ici
			 */ 
			public function showEnterCity(city:City):void
			{
				trace("SHOW ENTER CITY");
				if(Session.MOVE_A_UNIT){
					return;
				}
				
				for each(var cityInSession:City in Session.player.cities)
				{
					if(cityInSession.cityUID == city.cityUID){
						selectedCity = cityInSession;
						trace("found selectedCity");
						break;
					}
				}
				
				// on calcule si ce n'a pas été fait avant
				GameManager.getInstance().refreshCityWorkersOnResources(false, selectedCity, false);
				
				cellContent.enterCityForm.includeInLayout = true;
				cellContent.enterCityForm.visible = true;				
				cellContent.enterCityButton.enabled = selectedCity.beginTime < new Date().getTime();
				
				setBuildingCityProgressBar();
			}
				

			private function setBuildingCityProgressBar():void
			{
				var millisRemaining:Number = selectedCity.beginTime - new Date().getTime(); 
				
				var millisSpent:Number = Numbers.TIME_TO_BUILD_A_CITY - millisRemaining;
				
				var hours:int = millisRemaining/60/60/1000;
				var minutes:int = (millisRemaining-hours*60*60*1000)/60/1000;
				
				cellContent.buildingCityProgessBar.setProgress( millisSpent, Numbers.TIME_TO_BUILD_A_CITY );
				cellContent.labelBuildingCity.text = Translations.CITY_BUILDING_DONE.getItemAt(Session.LANGUAGE) + " " +(hours>9 ? "" : "0") + hours + "h"+ (minutes>9 ? "" : "0") + minutes;
			}
			
			//-----------------------------------------------------------//

			public function enterCity(event:MouseEvent):void
			{
				cityGroup.cityForm.refreshCity();
				appearCity.play();
			}
			
			
			//======================================================================================//
			
			public function placeBoard(x:int, y:int, simulateMouseClick:Boolean = true):void
			{
				trace("placeBoard  : " + x + " | " + y);
				mapPositioner.x = Session.MAP_WIDTH/2 
					- Utils.getXPixel(x)
					- Utils.getLandWidth()/2;
				mapPositioner.y = Session.MAP_HEIGHT/2 
					- Utils.getYPixel(y)
					- Utils.getLandHeight()/2;
				trace("mapPositioner  : " + mapPositioner.x + " | " + mapPositioner.y);

				
				Session.CENTER_X = x;
				Session.CENTER_Y = y;
				
				Session.COORDINATE_X = x;
				Session.COORDINATE_Y = y;
				
				try{
					Session.CURRENT_CELL_SELECTED = Session.map[x][y];
				}catch(e:Error){};
				
				if(simulateMouseClick)
					BoardClickAnalyser.getInstance().simulateClick(); // simule le click sur la case x,y
			}

		]]>
	</fx:Script>
	
	<!-- ====================================================================================== -->
	
	<fx:Declarations>
		<mx:Move id="appearCity"
				 xTo="0"
				 target="{cityGroup}"
				 easingFunction="{Quadratic.easeIn}"/>
		<mx:Move id="hideCity"
				 xTo="2500"
				 target="{cityGroup}"
				 easingFunction="{Quadratic.easeIn}"/>
		
		
		<s:Move id="hideChangeName" target="{changeNameWindow}" xTo="-375"/>
		<s:Move id="showChangeName" target="{changeNameWindow}" xTo="0"/>

		<s:Move id="hideCityChangeName" target="{changeCityNameWindow}" xTo="-375"/>
		<s:Move id="showCityChangeName" target="{changeCityNameWindow}" xTo="0"/>

		<s:Move id="hidePlayerUnits" target="{playerUnits}" xTo="-600"/>
		<s:Move id="showPlayerUnits" target="{playerUnits}" xTo="0"/>
		
	</fx:Declarations>
	
	<!-- ====================================================================================== -->
	
	<s:Group id="main" width="{Session.APPLICATION_WIDTH}" height="{Session.APPLICATION_HEIGHT}">
		
		<s:Group width="{Session.MAP_WIDTH}" 
				 height="{Session.MAP_HEIGHT}"
				 verticalCenter="0"
				 horizontalCenter="0"
				 id="boardImage"
				 clipAndEnableScrolling="true"	  
				 useHandCursor="true">
			<s:Group id="mapLayer"
					 width="{Numbers.LAND_WIDTH*400}"
					 height="{Numbers.LAND_HEIGHT*400}"
					 x="{mapPositioner.x}"
					 y="{mapPositioner.y}"
					 mouseEnabled="false"
					 mouseChildren="false"
					 mouseEnabledWhereTransparent="false"/>
			<s:Group id="pawnLayer"
					 width="{Numbers.LAND_WIDTH*400}"
					 height="{Numbers.LAND_HEIGHT*400}"
					 x="{mapPositioner.x}"
					 y="{mapPositioner.y}"
					 mouseEnabled="false"
					 mouseChildren="false"
					 mouseEnabledWhereTransparent="false"/>
			<s:Group id="highlighters"
					 width="{Numbers.LAND_WIDTH*400}"
					 height="{Numbers.LAND_HEIGHT*400}"
					 x="{mapPositioner.x}"
					 y="{mapPositioner.y}"
					 mouseEnabled="false"
					 mouseChildren="true"
					 mouseEnabledWhereTransparent="false">
				
				<mx:Image id="currentMouseHighLightNormal"
						  source="{ImageContainer.getImage(ImageContainer.HIGHLIGHT_BLANC)}"
						  visible="{!Session.MOVE_A_UNIT}"
						  x="{Session.COORDINATE_X * (Numbers.LAND_WIDTH - Numbers.LAND_WIDTH/4) * BoardDrawer.getInstance().scale}"
						  y="{Session.COORDINATE_Y * (Numbers.LAND_HEIGHT - Numbers.LAND_HEIGHT/2) * BoardDrawer.getInstance().scale}"
						  scaleX="{BoardDrawer.getInstance().scale}"
						  scaleY="{BoardDrawer.getInstance().scale}"
						  mouseEnabled="false"/>

				<mx:Image id="currentMouseHighLight4UnitMoves"
						  source="{ImageContainer.getImage(ImageContainer.HIGHLIGHT_BLANC)}"
						  visible="{Session.MOVE_A_UNIT}"
						  x="{Session.COORDINATE_X * (Numbers.LAND_WIDTH - Numbers.LAND_WIDTH/4) * BoardDrawer.getInstance().scale}"
						  y="{Session.COORDINATE_Y * (Numbers.LAND_HEIGHT - Numbers.LAND_HEIGHT/2) * BoardDrawer.getInstance().scale}"
						  scaleX="{BoardDrawer.getInstance().scale}"
						  scaleY="{BoardDrawer.getInstance().scale}"
						  mouseEnabled="false"/>

				<mx:Image id="currentSelectionHighLight"
						  source="{ImageContainer.getImage(ImageContainer.HIGHLIGHT_BLANC)}"
						  x="{Session.CURRENT_SELECTION_X * (Numbers.LAND_WIDTH - Numbers.LAND_WIDTH/4) * BoardDrawer.getInstance().scale}"
						  y="{Session.CURRENT_SELECTION_Y * (Numbers.LAND_HEIGHT - Numbers.LAND_HEIGHT/2) * BoardDrawer.getInstance().scale}"
						  scaleX="{BoardDrawer.getInstance().scale}"
						  scaleY="{BoardDrawer.getInstance().scale}"
						  mouseEnabled="false"/>
				
			</s:Group>
 		</s:Group>
		
		<s:Image source="{ImageContainer.BORDERS}"
				 x="{boardImage.x - 510}"
				 y="{boardImage.y - 220}"
				 />

		<s:Group width="{Session.MAP_WIDTH}" 
				 height="{Session.MAP_HEIGHT}"
				 verticalCenter="0"
				 horizontalCenter="0"
				 id="boardClickReceiver"
				 clipAndEnableScrolling="true"	  
				 useHandCursor="true">
			<s:Group id="mapPositioner" 
					 buttonMode="true"
					 width="{Numbers.LAND_WIDTH*400}"
					 height="{Numbers.LAND_HEIGHT*400}"
					 mouseDown="BoardClickAnalyser.getInstance().mouseDown(event)"
					 mouseMove="BoardClickAnalyser.getInstance().mouseMove(event)"
					 mouseUp="BoardClickAnalyser.getInstance().mouseUp(event)"/>
		</s:Group>
		
		<mx:Image source="{ImageContainer.ZOOM_IN}"
				  id="zoomInButton"
				  visible="{!Session.MOVE_A_UNIT &amp;&amp; !Session.WAIT_FOR_SERVER}"
				  x="{boardImage.x + 25}"
				  y="{boardImage.y - 15}"
				  click="{BoardDrawer.getInstance().zoom()}"/>
		<mx:Image source="{ImageContainer.ZOOM_OUT}"
				  id="zoomOutButton"
				  visible="{!Session.MOVE_A_UNIT &amp;&amp; !Session.WAIT_FOR_SERVER}"
				  x="{boardImage.x + 60}"
				  y="{boardImage.y - 14}"
				  click="BoardDrawer.getInstance().unzoom()"/>
		<mx:Image source="{ImageContainer.REFRESH}"
				  id="refreshButton"
				  visible="{!Session.MOVE_A_UNIT &amp;&amp; !Session.WAIT_FOR_SERVER}"
				  x="{boardImage.x + 95}"
				  y="{boardImage.y - 13}"
				  click="{GameManager.getInstance().getPlayer(Session.player)}"/>
	</s:Group>
	
	<!-- =============================================================================================== -->

	<components:CellContent id="cellContent"		
							top="155" 
							x="{boardImage.x+Session.MAP_WIDTH + 65}"/>
	
	<mx:Image source="{ImageContainer.MINI_LOGO}" right="50" y="-7"/>
	<mx:Image source="{ImageContainer.ARROW_RIGHT}" 
			  id="openPlayerUnitsButton"
			  x="2" y="160"
			  alpha="0.6"
			  click="{showPlayerUnits.play()}"/>
	
	<components:StepProgress bottom="20" x="{boardImage.x+Session.MAP_WIDTH + 65}"/>
	
	<s:HGroup width="100%" horizontalAlign="center" paddingTop="5"
			  bottom="70"
			  x="{boardImage.x+Session.MAP_WIDTH + 20}">
		<s:Label text="X : {Session.COORDINATE_X}"/>
		<mx:Spacer width="50"/>
		<s:Label text="Y : {Session.COORDINATE_Y}"/>
	</s:HGroup>
	
	<!-- ====================================================================================== -->
		  
	<mx:SWFLoader source="{ImageContainer.LOADING}" 
		 		  visible="{Session.WAIT_FOR_SERVER}"
				  x="{boardImage.x+50}"
				  y="{boardImage.y+Session.MAP_HEIGHT - 16}"
				  rotation="2"/>
	
	<!-- ====================================================================================== -->
	
	<windows:ChangeName id="changeNameWindow" x="-375" y="100" type="1"/>
	<windows:ChangeName id="changeCityNameWindow" x="-375" y="100" type="2"/>
	<windows:PlayerUnits id="playerUnits" x="-600" y="100"/>
	<windows:CityGroup id="cityGroup" x="2500" y="{Session.HEADER_HEIGHT}"
					   width="{Session.APPLICATION_WIDTH}"
					   height="{Session.APPLICATION_HEIGHT - Session.HEADER_HEIGHT - Session.FOOTER_HEIGHT}"
					   selectedCity="@{selectedCity}"/>
	
</s:Group>
