<?xml version="1.0" encoding="utf-8"?>
<windows:ResizableTitleWindow xmlns:fx="http://ns.adobe.com/mxml/2009" 
			   xmlns:s="library://ns.adobe.com/flex/spark" 
			   xmlns:mx="library://ns.adobe.com/flex/mx"
			   xmlns:windows="com.uralys.tribes.windows.*"
			   skinClass="com.uralys.tribes.skins.WindowSkin"
			   close="{closeWindow()}"
			   width="440"
			   height="420"
			   backgroundAlpha="0.7"
			   backgroundColor="#000000"
			   cornerRadius="15"
			   >
	
	
	<fx:Script>
		<![CDATA[
			//-----------------------------------------------------------------//
			
			import com.uralys.tribes.commons.Session;
			import com.uralys.tribes.commons.Translations;
			import com.uralys.tribes.entities.Message;
			import com.uralys.tribes.managers.GameManager;
			
			import mx.collections.ArrayCollection;
			import mx.core.FlexGlobals;
			import mx.managers.PopUpManager;

			//-----------------------------------------------------------------//

			public function closeWindow():void
			{
				var messagesToRemoveFromNews:ArrayCollection = new ArrayCollection();
				var messagesToRemoveFromReads:ArrayCollection = new ArrayCollection();
				var messagesToRemoveFromArchived:ArrayCollection = new ArrayCollection();

				var messageToMarkAsReadUIDs:ArrayCollection = new ArrayCollection();
				var messageToDeleteUIDs:ArrayCollection = new ArrayCollection();
				var messageToArchiveUIDs:ArrayCollection = new ArrayCollection();
				
				//---------------------------//
				
				for each(var message:Message in Session.player.newMessages)
				{
					if(message.status == Message.READ){
						Session.player.readMessages.addItem(message);
						messagesToRemoveFromNews.addItem(message);
						messageToMarkAsReadUIDs.addItem(message.messageUID);
					}
				}

				for each(var messageToRemoveFromNews:Message in messagesToRemoveFromNews){
					Session.player.newMessages.removeItemAt(Session.player.newMessages.getItemIndex(messageToRemoveFromNews));
				}

				//---------------------------//
				
				for each(var message:Message in Session.player.readMessages)
				{
					if(message.status == Message.DELETED){
						messagesToRemoveFromReads.addItem(message);
						messageToDeleteUIDs.addItem(message.messageUID);
					}

					else if(message.status == Message.ARCHIVED){
						messagesToRemoveFromReads.addItem(message);
						messageToArchiveUIDs.addItem(message.messageUID);
					}
				}
				
				for each(var messageToRemoveFromReads:Message in messagesToRemoveFromReads){
					Session.player.newMessages.removeItemAt(Session.player.newMessages.getItemIndex(messageToRemoveFromReads));
				}

				//---------------------------//
				
				for each(var message:Message in Session.player.archivedMessages)
				{
					if(message.status == Message.DELETED){
						messagesToRemoveFromArchived.addItem(message);
						messageToDeleteUIDs.addItem(message.messageUID);
					}
				}
				
				//---------------------------//

				GameManager.getInstance().markAsRead(messageToMarkAsReadUIDs);
				GameManager.getInstance().archiveMessages(messageToArchiveUIDs);
				GameManager.getInstance().deleteMessages(messageToDeleteUIDs);

				//---------------------------//
				
				PopUpManager.removePopUp(this);
			}
			//-----------------------------------------------------------------//
			
			public function refresh():void
			{
				//GameManager.getInstance().sendMessage(message.text);
			}
			
		]]>
	</fx:Script>
	
	<s:Group width="100%" height="100%">
		
		
		<s:VGroup horizontalAlign="center" top="5" width="100%">
			<mx:SWFLoader source="{ImageContainer.LOADING}" 
						  visible="{Session.WAIT_FOR_SERVER}"/>
			<s:TabBar id="tabs" dataProvider="{viewstack}"
					  skinClass="com.uralys.tribes.skins.CustomTabBarSkin"/>
		</s:VGroup>
		
		<mx:ViewStack id="viewstack" 
					  width="100%" height="100%"
					  paddingTop="55"
					  paddingLeft="15"
					  paddingRight="15"
					  paddingBottom="15"
					  >
			
			<s:NavigatorContent label="{Translations.UNREAD.getItemAt(Session.LANGUAGE)} ({Session.player.newMessages.length})">
				<s:HGroup width="100%" height="100%"
						  horizontalAlign="center"
						  verticalAlign="middle">
					<s:List dataProvider="{Session.player.newMessages}"
							id="newMessagesList"
							height="90%"
							width="40%"
							selectionColor="#000101"
							rollOverColor="#000101"
							itemRenderer="com.uralys.tribes.renderers.MessageRenderer"
							skinClass="com.uralys.tribes.skins.CustomListSkin"/>
					<s:Label width="60%"
							 text="{(newMessagesList.selectedItem as Message).content}"
							 color="#ffffff"/>
				</s:HGroup>
			</s:NavigatorContent>
			<s:NavigatorContent label="{Translations.READ.getItemAt(Session.LANGUAGE)} ({Session.player.readMessages.length})">
				<s:HGroup width="100%" height="100%"
						  horizontalAlign="center"
						  verticalAlign="middle">
					<s:List dataProvider="{Session.player.readMessages}"
							id="readMessagesList"
							height="90%"
							width="40%"
							selectionColor="#000101"
							rollOverColor="#000101"
							itemRenderer="com.uralys.tribes.renderers.MessageRenderer"
							skinClass="com.uralys.tribes.skins.CustomListSkin"/>
					<s:Label width="60%"
							 text="{(readMessagesList.selectedItem as Message).content}"
							 color="#ffffff"/>
				</s:HGroup>
			</s:NavigatorContent>
			<s:NavigatorContent label="{Translations.ARCHIVES.getItemAt(Session.LANGUAGE)} ({Session.player.archivedMessages.length})">
				<s:HGroup width="100%" height="100%"
						  horizontalAlign="center"
						  verticalAlign="middle">
					<s:List dataProvider="{Session.player.archivedMessages}"
							id="archivedMessagesList"
							height="90%"
							width="40%"
							selectionColor="#000101"
							rollOverColor="#000101"
							itemRenderer="com.uralys.tribes.renderers.MessageRenderer"
							skinClass="com.uralys.tribes.skins.CustomListSkin"/>
					<s:Label width="60%"
							 text="{(archivedMessagesList.selectedItem as Message).content}"
							 color="#ffffff"/>
				</s:HGroup>
			</s:NavigatorContent>
		</mx:ViewStack>
	</s:Group>
	
</windows:ResizableTitleWindow>
