<?xml version="1.0" encoding="utf-8"?>
<s:Group xmlns:fx="http://ns.adobe.com/mxml/2009" 
		 xmlns:s="library://ns.adobe.com/flex/spark" 
		 xmlns:mx="library://ns.adobe.com/flex/mx" width="100%" height="100%">
	
	<fx:Script>
		<![CDATA[
			import com.uralys.tribes.commons.Names;
			import com.uralys.tribes.commons.Session;
			import com.uralys.tribes.core.Pager;
			import com.uralys.tribes.managers.AccountManager;
			import com.uralys.utils.SHA1;
			import com.uralys.utils.Utils;
			
			import mx.core.FlexGlobals;
			
			[Bindable] private var savedEmail:String = '';
			[Bindable] private var savedPassword:String = '';
			
			private function initForm():void{
				var sharedObject:SharedObject = SharedObject.getLocal(Names.SHARED_OBJECT_NAME);
				savedEmail = sharedObject.data.lastEmail;
				savedPassword = sharedObject.data.lastPassword;
			}
			
			private function login():void{
				Session.WAIT_FOR_CONNECTION = true;
				if(formChecked()){
					var sharedObject:SharedObject = SharedObject.getLocal(Names.SHARED_OBJECT_NAME);
					sharedObject.data.lastEmail = emailInput.text;
					sharedObject.data.lastPassword = passwordInput.text;
					
					AccountManager.getInstance().login(emailInput.text, SHA1.encrypt(passwordInput.text));
				}
				else
					Session.WAIT_FOR_CONNECTION = false;
			}	
			
			private function createAccount():void{
				Session.WAIT_FOR_SERVER = true;
				if(formChecked()){
					var sharedObject:SharedObject = SharedObject.getLocal(Names.SHARED_OBJECT_NAME);
					sharedObject.data.lastEmail = emailInput.text;
					sharedObject.data.lastPassword = passwordInput.text;
				
					AccountManager.getInstance().register(emailInput.text, SHA1.encrypt(passwordInput.text));
				}
				else
					Session.WAIT_FOR_CONNECTION = false;
			}

			private function formChecked():Boolean{
				if(!Utils.isValidEmail(emailInput.text))
					FlexGlobals.topLevelApplication.message('Check your email', 3);
				else if(passwordInput.text.length < 3)
					FlexGlobals.topLevelApplication.message('Password must be at least 3 characters', 3);
				else
					return true;
				
				return false;
			}
		]]>
	</fx:Script>
	
	<s:VGroup width="100%" 
			  horizontalAlign="center"
			  creationComplete="initForm()">
		<mx:Spacer width="30"/>
		<mx:Grid >
			<mx:GridRow >
				<mx:GridItem >
					<s:Label text="email" />
				</mx:GridItem>
				<mx:GridItem>
					<s:TextInput id="emailInput"
								 text="{savedEmail}"
								 width="200"/>
				</mx:GridItem>
			</mx:GridRow>
			<mx:GridRow >
				<mx:GridItem >
					<s:Label text="password" />
				</mx:GridItem>
				<mx:GridItem>
					<s:TextInput id="passwordInput" 	
								 text="{savedPassword}"	
								 displayAsPassword="true"
								 width="200"/>
				</mx:GridItem>
			</mx:GridRow>
		</mx:Grid>
		<s:HGroup visible="{!Session.WAIT_FOR_CONNECTION}">
			<mx:Spacer width="5"/>
			<s:Button label="Create my account" click="{createAccount()}"/>
			<mx:Spacer width="50"/>
			<s:Button label="Log me in" click="{login()}"/>
		</s:HGroup>
	</s:VGroup>
</s:Group>
